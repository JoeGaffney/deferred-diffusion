name: IT Tests

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Enables manual triggering

permissions:
  contents: read
  
env:
  REPO_USERNAME: joegaffney
  REPO: deferred-diffusion
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
  DDIFFUSION_ADMIN_KEY: ci_admin_key_1234567890abcdef

jobs:
  it-tests:  
    runs-on: ubuntu-latest
    steps:
    - name: Free Disk Space (Ubuntu)
      uses: insightsengineering/disk-space-reclaimer@v1
      with:
        android: true
        dotnet: true
        haskell: false
        large-packages: false
        swap-storage: false
        docker-images: false
        tools-cache: false

    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install requirements
      run: pip install -r api/requirements.txt

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ env.REPO_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
      
    - name: Docker Compose up
      run: |
        make up-it-tests

    - name: Wait for services to be ready
      run: |
        timeout 300 bash -c 'until curl -f http://127.0.0.1:5000/health || curl -f http://127.0.0.1:5000/docs; do sleep 5; done'

    - name: Create Test API Key
      run: |
        RESPONSE=$(curl -s -X POST "http://127.0.0.1:5000/admin/keys?name=TestKey" \
          -H "Authorization: Bearer ${{ env.DDIFFUSION_ADMIN_KEY }}" \
          -H "Content-Type: application/json")
        echo "Response: $RESPONSE"
        API_KEY=$(echo $RESPONSE | jq -r '.api_key')
        echo "DDIFFUSION_API_KEY=$API_KEY" >> $GITHUB_ENV

    - name: Generate clients
      run: |
        make generate-clients-raw

    - name: Run mypy on api
      run: |
        make mypy-api

    - name: Run mypy on cpu-workers
      run: |
        make mypy-cpu-workers

    - name: Run IT Tests - External
      run: |
        make it-tests-external-ci